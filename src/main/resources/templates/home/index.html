<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=width.advice, initial-scale=1.0">
    <title>Projeto mapa</title>
    <meta name="autor" content="Gui">
    <style>
        #map{
            height: 400px;
            width: 740px;
        }
    </style>
</head>
<body>
<div id="map"></div>

<script th:inline="javascript">

    var streetNumber = [[${numero}]];
    var street = [[${rua}]];
    var neighborhood = [[${bairro}]];
    var city = "Garanhuns";
    var state = "Pernambuco";
    var country = "Brazil";

    function initMap() {
        var geocoder = new google.maps.Geocoder();
        var address = streetNumber + ' ' + street + ', ' + neighborhood + ', ' + city + ', ' + state + ', ' + country;

        geocoder.geocode({ 'address': address }, function (results, status) {
            if (status == google.maps.GeocoderStatus.OK) {
                var latitude = results[0].geometry.location.lat();
                var longitude = results[0].geometry.location.lng();

                var map = new google.maps.Map(document.getElementById("map"), { center: { lat: latitude, lng: longitude }, zoom: 17 });

                var marker = new google.maps.Marker({
                    position: { lat: latitude, lng: longitude },
                    map: map,
                    title: 'Localização'
                });
            } else {
                console.error('Geocoding failed. Status: ' + status);
            }
        });
    }
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDAhefUroNgMWN6d8pKFFFLPrrNM9aaMSc&callback=initMap" async defer></script>

<!-- Adicionando o formulário para enviar avaliações -->
<form id="avaliacaoForm" th:action="@{'/avaliacao/publicar/' + ${local.id}}" method="post" onsubmit="return enviarAvaliacao()">
    <h4>Avaliar o Local:</h4>
    <label for="nota">Nota:</label>
    <input type="number" id="nota" name="nota" required>

    <label for="comentario">Comentário:</label>
    <textarea id="comentario" name="comentario" required></textarea>

    <label for="nomeAutor">Nome do Autor:</label>
    <input type="text" id="nomeAutor" name="nomeAutor" required>

    <button type="submit">Enviar Avaliação</button>
</form>

<div>
    <h3 th:text="${local.nome}"></h3>
    <p th:text="${local.descricao}"></p>
    <p th:text="${local.rua + ' ' + local.numero + ', ' + local.bairro}"></p>
    <p th:text="${local.recursos}"></p>
    <p th:text="${local.dataCadastro}"></p>
    <p th:text="${local.autor}"></p>
    <p th:text="${local.media}"></p>

    <h4>Avaliações:</h4>
    <ul th:if="${local.avaliacoes != null}">
        <li th:each="avaliacao : ${local.avaliacoes}">
            Nota: <span th:text="${avaliacao.nota}"></span><br/>
            Comentário: <span th:text="${avaliacao.comentario}"></span><br/>
            Data: <span th:text="${avaliacao.data}"></span><br/>
            <hr/>
        </li>
    </ul>
</div>

<script th:inline="javascript">
    async function enviarAvaliacao() {
        const nota = document.getElementById('nota').value;
        const comentario = document.getElementById('comentario').value;
        const nomeAutor = document.getElementById('nomeAutor').value;

        const avaliacaoData = {
            nota: parseFloat(nota),
            comentario: comentario,
            nomeAutor: nomeAutor
        };

        const response = await fetch("/avaliacao/publicar/" + local.id, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(avaliacaoData)
        });

        if (response.ok) {
            console.log('Avaliação enviada com sucesso!');
        } else {
            console.error('Erro ao enviar avaliação:', response.statusText);
        }

        return false;
    }
</script>

</body>
</html>
